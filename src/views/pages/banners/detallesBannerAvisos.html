<!DOCTYPE html>
<html lang="es-MX">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="/js/config.js"></script>
    <title id="title">CPanel - Mega</title>
    <meta name="viewport" id="metaViewport" content="">
    <meta name="title" id="metaTitle" content="">
    <meta name="author" id="metaAuthor" content="">
    <meta name="description" id="metaDescription" content="">
    <meta name="keywords" id="metaKeywords" content="">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.3.0/styles/overlayscrollbars.min.css" integrity="sha256-dSokZseQNT08wYEWiz5iLI8QPlKxG+TswNRD8k35cpg=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css" integrity="sha256-Qsx5lrStHZyR9REqhUF8iQt73X06c8LGIUPzpOhwRrI=" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/adminlte.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css" integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/css/jsvectormap.min.css" integrity="sha256-+uGLJmmTKOqBr+2E6KDYs/NRsHxSkONXFHUL0fy2O/4=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
</head>
<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
        <nav class="app-header navbar navbar-expand bg-body">
            <div class="container-fluid">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
                            <i class="bi bi-list"></i>
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown user-menu">
                        <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-person"></i>
                            <span class="d-none d-md-inline">Administrador</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                            <li class="user-header text-bg-primary">
                                <img src="/assets/img/logoMega.png" class="rounded-circle shadow" alt="User Image">
                                <p>Administrador - Web Developer</p>
                            </li>
                            <li class="user-footer">
                                <a href="#" class="btn btn-default btn-flat">Settings</a>
                                <a href="#" class="btn btn-default btn-flat float-end">Sign out</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
        <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark" id="left-sidebar"></aside>
        <main class="app-main">
            <div class="app-content-header">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-6">
                            <h3 class="mb-0">Banner de avisos</h3>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-end">
                                <li class="breadcrumb-item"><a href="/index">Home</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Banner de avisos</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <div class="app-content">
                <div class="container-fluid">
                    <section class="content">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Detalles de avisos</h3>
                                <div class="card-tools">
                                    <!-- Aquí se insertarán los botones dinámicamente -->
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-5 card-body-left">
                                        <!-- Aquí se insertarán los detalles dinámicamente -->
                                    </div>
                                    <div class="col-md-12">
                                        <h3>Sucursales con Permiso</h3>
                                        <div id="sucursales-list" class="row"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <!-- Aquí se puede agregar contenido adicional si es necesario -->
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
        <footer class="app-footer" id="footer"></footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.3.0/browser/overlayscrollbars.browser.es6.min.js" integrity="sha256-H2VM7BKda+v2Z4+DRy69uknwxjyDRhszjXFhsL4gD3w=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha256-whL0tQWoY1Ku1iskqPFvmZ+CHsvmRWx/PIoEvIeWh4I=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha256-YMa+wAM6QkVyz999odX7lPRxkoYAan8suedu4k2Zur8=" crossorigin="anonymous"></script>
    <script>
        function onDOMContentLoaded() {
            cargaLeftSidebar();
            cargaNavBar();
            console.log('cargar secciones');
        }
        document.addEventListener("DOMContentLoaded", onDOMContentLoaded);
    </script>
    <script src="/js/adminlte.js"></script>
    <script src="/js/componentes.js"></script>
    <script>
        const SELECTOR_SIDEBAR_WRAPPER = ".sidebar-wrapper";
        const Default = {
            scrollbarTheme: "os-theme-light",
            scrollbarAutoHide: "leave",
            scrollbarClickScroll: true,
        };
        document.addEventListener("DOMContentLoaded", function () {
            const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
            if (sidebarWrapper && typeof OverlayScrollbarsGlobal?.OverlayScrollbars !== "undefined") {
                OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
                    scrollbars: {
                        theme: Default.scrollbarTheme,
                        autoHide: Default.scrollbarAutoHide,
                        clickScroll: Default.clickScroll,
                    },
                });
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            fetch(`/bannerAvisos/ver/data?id=${id}`)
                .then(response => response.json())
                .then(data => {
                    const active = data.status ? "Activo" : "Inactivo";
                    const statusButton = data.status ?
                        `<a onclick="desactivarBannerAvisos(${data.idBanner}); return false;" class="btn btn-outline-danger" title="Desactivar"><i class="bi bi-eye-slash">Desactivar</i></a>` :
                        `<a onclick="activarBannerAvisos(${data.idBanner}); return false;" class="btn btn-outline-success" title="Activar"><i class="bi bi-eye">Activar</i></a>`;

                    const cardTools = document.querySelector('.card-tools');
                    cardTools.innerHTML = `<a href="/bannerAvisos/editar?id=${data.idBanner}" class="btn btn-outline-primary" title="Editar"><i class="bi bi-file-earmark-text">Editar</i></a>${statusButton}`;

                    const fhInicio = new Date(data.fhInicio).toLocaleDateString();
                    const fhFin = new Date(data.fhFin).toLocaleDateString();

                    const cardBodyLeft = document.querySelector('.card-body-left');
                    cardBodyLeft.innerHTML = `
                        <p>Nombre del card: <b> ${data.nameBanner} </b> </p>
                        <p>Id: <b> ${data.idBanner} </b> </p>
                        <p>Link del bonton de acción: <b> ${data.link} </b> </p>
                        <p>Imagen Banner: <b>  </b>
                            <img src="${config.serverUrl}src/assets/uploads/bannerHomeFooter/${data.archivo}" alt="${data.archivo}" style="width: 100%; height: auto;">  
                        </p>
                        <p>Imagen Banner version movil: <b>  </b><br>
                            <img src="${config.serverUrl}src/assets/uploads/bannerHomeFooter/${data.archivoMovil}" alt="${data.archivoMovil}" style="width: 50%; height: auto;">  
                        </p>
                        <p>Status:<b> ${active} </b> </p>
                        <p>Fecha de inicio:<b> ${fhInicio} </b> </p>
                        <p>Fecha Fin:<b> ${fhFin} </b></p>
                    `;

                    // Obtener la lista de permisos
                    fetch(`/bannerAvisos/permisos?objetoName=BannerAvisosHome&idObjeto=${data.idBanner}`)
                        .then(response => response.json())
                        .then(permisos => {
                            const permisosMap = new Map();
                            permisos.forEach(permiso => {
                                permisosMap.set(permiso.idSucursal, true);
                            });

                            // Obtener la lista de sucursales
                            fetch('/api/sucursales')
                                .then(response => response.json())
                                .then(sucursales => {
                                    const sucursalesList = document.getElementById('sucursales-list');

                                    // Mostrar solo las sucursales activas al cargar la página
                                    sucursales.forEach(sucursal => {
                                        if (permisosMap.has(sucursal.idSucursal)) {
                                            const div = document.createElement('div');
                                            div.className = 'col-md-3'; // Para acomodar en 4 columnas
                                            div.textContent = sucursal.sucursalName;

                                            sucursalesList.appendChild(div);
                                        }
                                    });
                                })
                                .catch(error => console.error('Error al obtener sucursales:', error));
                        })
                        .catch(error => console.error('Error al obtener permisos:', error));
                })
                .catch(error => console.error('Error al obtener el banner:', error));
        });

        function activarBannerAvisos(id) {
            fetch(`/bannerAvisos/activar/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Recargar la página para reflejar los cambios
                    } else {
                        console.error('Error al activar el banner:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error al activar el banner:', error);
                });
        }

        function desactivarBannerAvisos(id) {
            fetch(`/bannerAvisos/desactivar/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Recargar la página para reflejar los cambios
                    } else {
                        console.error('Error al desactivar el banner:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error al desactivar el banner:', error);
                });
        }
    </script>
</body>
</html>